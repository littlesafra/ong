#borrar variables de entorno
dbDisconnect(con)
remove(list = ls())

#conexion base de datos
#install.packages("RMySQL")
library(DBI)
con <- dbConnect(RMySQL::MySQL(), user="root", host="3.212.217.185:3306", password="password", dbname="ONGDATABASE")


#leer fichero
library("readxl")
data <- read_excel("/Users/ACER/Desktop/DataSetComarcas2016.xls")
data <- data[with(data, order(data$Ambitos_Territoriales)), ] 

#Eliminar caracteres raros
for(i in 1:nrow(data)){
  print(i, nrow(data))
  data[i,1] <- chartr('??????','aeioun', data[i,1])
}



#Escalar datos(valor neutro)
data.scale <- scale(data[,2:7])

#M?todo elbow para sacar el n?mero optimo de clusters
k.max <- 15
wss <- sapply(1:k.max, 
              function(k){kmeans(data.scale, k, nstart=50,iter.max = 15 )$tot.withinss})
plot(1:k.max, wss,
     type="b", pch = 19, frame = FALSE, 
     xlab="N?mero de clusters K",
     ylab="Suma total de cuadrados dentro de los clusters", col="blue")
     
     
     
#Podemos observar que en el gr?fico el codo se marca en el n?mero 5

set.seed(80)
data.km <- kmeans(data.scale,centers = 5)

#contenido del objeto
names(data.km)

#asignaciones del cluster
data.km$cluster

#a?adimos clusters a la tabla
data$Cluster <- data.km$cluster

#Poblacion total
Poblacion_total <- sum(data$Poblacion)


#Utilizando For

for(i in 1:5){
  
  Poblacion <- sum(data$Poblacion[data$Cluster == i])
  Inmigracion <- sum(data$Inmigracion[data$Cluster == i])
  Tasa_paro <- mean(data$Tasa_paro[data$Cluster == i])
  Renta_Personal <- mean(data$Renta_Personal[data$Cluster == i])
  Renta_Familiar <- mean(data$Renta_Familiar[data$Cluster == i])
  Renta_Mixta <- (Renta_Personal/Renta_Familiar * 100)
  porcentajePoblacion <- porcentajePoblacion <- Poblacion * 100 / Poblacion_total
  Cluster <- i
  
    if(i == 1)g1 <- data.frame(cbind(Poblacion,Inmigracion,Tasa_paro,Renta_Personal,Renta_Familiar,Renta_Mixta,porcentajePoblacion,Cluster))
    else if(i == 2)g2 <- data.frame(cbind(Poblacion,Inmigracion,Tasa_paro,Renta_Personal,Renta_Familiar,Renta_Mixta,porcentajePoblacion,Cluster))
    else if(i == 3)g3 <- data.frame(cbind(Poblacion,Inmigracion,Tasa_paro,Renta_Personal,Renta_Familiar,Renta_Mixta,porcentajePoblacion,Cluster))
    else if(i == 4)g4 <- data.frame(cbind(Poblacion,Inmigracion,Tasa_paro,Renta_Personal,Renta_Familiar,Renta_Mixta,porcentajePoblacion,Cluster))
    else g5 <- data.frame(cbind(Poblacion,Inmigracion,Tasa_paro,Renta_Personal,Renta_Familiar,Renta_Mixta,porcentajePoblacion,Cluster))
}

medias_total <- data.frame(rbind(as.matrix(g1),as.matrix(g2),as.matrix(g3),as.matrix(g4),as.matrix(g5)))



#Mostramos un grafico XY con la poblacion por
plot(medias_total$porcentajePoblacion,medias_total$Renta_Mixta, ylab="% Renta Mixta", xlab="% Poblacion", col="Red")




#Tabla indentificador cuadrante

 Renta_Cuadrante <- (max(medias_total$Renta_Mixta) + min(medias_total$Renta_Mixta))/2
 Poblacion_Cuadrante <- (max(medias_total$porcentajePoblacion) + min(medias_total$porcentajePoblacion))/2
  
for(i in 1:5){
  
  Grupo <- i
  Renta_Mixta <- medias_total$Renta_Mixta[medias_total$Cluster == i]
  porcentajePoblacion <- medias_total$porcentajePoblacion[medias_total$Cluster == i]
  Porcentaje_Recursos <- 0
  Distancia <- 0
    
    if(Renta_Mixta >= Renta_Cuadrante && porcentajePoblacion < Poblacion_Cuadrante){
  
      Cuadrante <- as.numeric(1)
      Importancia <- as.numeric(5)
    
    }else if(Renta_Mixta >= Renta_Cuadrante && porcentajePoblacion >= Poblacion_Cuadrante){
    
      Cuadrante <- as.numeric(2)
      Importancia <- as.numeric(20)
    
    }else if(Renta_Mixta < Renta_Cuadrante && porcentajePoblacion < Poblacion_Cuadrante){
    
      Cuadrante <- as.numeric(3)
      Importancia <- as.numeric(30)
    
    }else{
    
      Cuadrante <- as.numeric(4)
      Importancia <- as.numeric(45)
    
    } 
    
    if(i == 1)t1 <- data.frame(cbind(Grupo,Renta_Mixta,porcentajePoblacion,Importancia,Cuadrante,Porcentaje_Recursos,Distancia))
    else if(i == 2)t2 <- data.frame(cbind(Grupo,Renta_Mixta,porcentajePoblacion,Importancia,Cuadrante,Porcentaje_Recursos,Distancia))
    else if(i == 3)t3 <- data.frame(cbind(Grupo,Renta_Mixta,porcentajePoblacion,Importancia,Cuadrante,Porcentaje_Recursos,Distancia))
    else if(i == 4)t4 <- data.frame(cbind(Grupo,Renta_Mixta,porcentajePoblacion,Importancia,Cuadrante,Porcentaje_Recursos,Distancia))
    else t5 <- data.frame(cbind(Grupo,Renta_Mixta,porcentajePoblacion,Importancia,Cuadrante,Porcentaje_Recursos,Distancia))
  
}

Tabla_Cuadrante <- data.frame(rbind(as.matrix(t1),as.matrix(t2),as.matrix(t3),as.matrix(t4),as.matrix(t5)))

#Para el calculo de las distancias
Poblacion<- 0
Inmigracion <- 0
Tasa_paro <- 0
Renta_Personal <- 0
Renta_Familiar <- 0
Renta_Mixta <- 0
porcentajePoblacion <- Poblacion * 100 / Poblacion_total
Cluster <- 0
g6 <- data.frame(cbind(Poblacion, Inmigracion, Tasa_paro, Renta_Personal, Renta_Familiar, Renta_Mixta,porcentajePoblacion,Cluster))
medias_total <- data.frame(rbind(as.matrix(g1),as.matrix(g2),as.matrix(g3),as.matrix(g4),as.matrix(g5),as.matrix(g6)))

#Borrar variables inecesarias
remove(g1,g2,g3,g4,g5,g6,t1,t2,t3,t4,t5)
Distancias_Totales <- dist(scale(medias_total))


Tabla_Cuadrante[1,7] <- lapply(Distancias_Totales[5],round, 1)
Tabla_Cuadrante[2,7] <- lapply(Distancias_Totales[9],round, 1)
Tabla_Cuadrante[3,7] <- lapply(Distancias_Totales[12],round, 1)
Tabla_Cuadrante[4,7] <- lapply(Distancias_Totales[14],round, 1)
Tabla_Cuadrante[5,7] <- lapply(Distancias_Totales[15],round, 1)

#grupos por cuadrante
remove(i)

cont1 <- 0
cont2 <- 0
cont3 <- 0
cont4 <- 0


for(i in 1:5){
  if(Tabla_Cuadrante[i,5] == 1){
    if(cont1 == 0){
      Grupo1 <- Tabla_Cuadrante[i,]
      cont1 <- 1
    }
    else{
      fila <- data.frame(Tabla_Cuadrante[i,])
      Grupo1 <- rbind(Grupo1,fila)
    }
  }else if(Tabla_Cuadrante[i,5] == 2){
    if(cont2 == 0){
      Grupo2 <- Tabla_Cuadrante[i,]
      cont2 <- 1
    }
    else{
      fila <- data.frame(Tabla_Cuadrante[i,])
      Grupo2 <- rbind(Grupo2,fila)
    }
  }else if(Tabla_Cuadrante[i,5] == 3){
    if(cont3== 0){
      Grupo3 <- Tabla_Cuadrante[i,]
      cont3 <- 1
    }
    else{
      fila <- data.frame(Tabla_Cuadrante[i,])
      Grupo3<- rbind(Grupo3,fila)
    }
  
  }else{
    if(cont4 == 0){
      Grupo4 <- Tabla_Cuadrante[i,]
      cont4 <- 1
    }
    else{
      fila <- data.frame(Tabla_Cuadrante[i,])
      Grupo4 <- rbind(Grupo4,fila)
    }
  
  }
}

#Borrar variaables inecesarias
remove(fila,cont1,cont2,cont3,cont4,i,Cluster,Cuadrante,Distancia,Distancias_Totales,Grupo,Importancia,Inmigracion,Poblacion,Poblacion_Cuadrante,Porcentaje_Recursos,Renta_Cuadrante,Renta_Familiar,Renta_Mixta,Renta_Personal,Tasa_paro,Poblacion_total,porcentajePoblacion)

#calculo porcentaje de recursos
Importancia_Total <- sum(Tabla_Cuadrante$Importancia)

for(i in 1:5){
  Tabla_Cuadrante[i,6] <- lapply(100*Tabla_Cuadrante[i,4]/Importancia_Total,round,1)
}

for(i in 1:5){
  if(Tabla_Cuadrante[i,5] == 4){
    for(j in 1:3){
      if(Tabla_Cuadrante[i,7] > Grupo4[j,7]){
      
        Tabla_Cuadrante[i,6] <- Tabla_Cuadrante[i,6] - (Tabla_Cuadrante[i,7] - Grupo4[j,7])*5
      
      }else{
        
        Tabla_Cuadrante[i,6] <- Tabla_Cuadrante[i,6] + (Grupo4[j,7] - Tabla_Cuadrante[i,7])*5
        
      }
    }
  }
}

#Tabla de necesidades por destino
  Necesidades_Destino <- data[,1]
  for(tipo in 1:5){
    myQuery <- paste0("select porcentaje_necesidad '",tipo,"' from necesidad_sucursal where categoria_id='",tipo,"';")
    dbGetQuery(con,myQuery)
    Necesidades_Destino <- cbind(Necesidades_Destino, dbGetQuery(con,myQuery))
   }
   
#Añadimos los cluster a la tabla
  Necesidades_Destino$Cluster <- data$Cluster
    
#Totales de recursos por categor????a
  total.recurso = array()
  for(i in 1:5){
    myQuery <- paste0("Select sum(stock) from producto where categoria_id = '",i,"';")
    print(myQuery)
    recurso <- as.numeric(dbGetQuery(con,myQuery))
    a <- recurso * 0.95
    total.recurso[i] <-  lapply(a, round,0)
  }

#Recursos a cada cluster
  total.recursos.cluster = matrix(1:25, nrow=5, ncol=5) 

  for(col in 1:5){
    for(row in 1:5){
      x<-as.numeric(total.recurso[col])
      y<-as.numeric(Tabla_Cuadrante[row,6])
      eragiketa <-as.numeric((x*y / 100))
      eragiketa <- as.numeric(lapply(eragiketa, round,0))
      total.recursos.cluster[row, col] <- eragiketa
  }
}

#Asignación de paquetes a cada comarca
library(dplyr)
total.necesidad.cluster= matrix(1:25, nrow=5, ncol=5) 

#suma necesidades por cluster
cluster<-1
col<-1
for(cluster in 1:5){
    filtro <- filter(Necesidades_Destino, Necesidades_Destino$Cluster == cluster)
    total.necesidad.cluster[cluster, 1] <- sum(filtro$'1')
    total.necesidad.cluster[cluster, 2] <- sum(filtro$'2')
    total.necesidad.cluster[cluster, 3] <- sum(filtro$'3')
    total.necesidad.cluster[cluster, 4] <- sum(filtro$'4')
    total.necesidad.cluster[cluster, 5] <- sum(filtro$'5')
}


Asignacion_Destino <- Necesidades_Destino
myQuery <- "select max(id) from envio;"
maximo <- dbGetQuery(con,myQuery)

for(col in 1:5){
  for(row in 1:20){
  
    cluster <- Necesidades_Destino[row, 7]
    
       necesidadDestino<-as.numeric(Necesidades_Destino[row, col+1])
       
       necesidadTotal<-as.numeric(total.necesidad.cluster[cluster, col])
      
       recursoTotal<-as.numeric(total.recursos.cluster[cluster,col])
    

       eragiketa <- necesidadDestino*recursoTotal
       eragiketa<-as.numeric(necesidadDestino*recursoTotal/necesidadTotal)
       eragiketa<-  as.numeric(lapply(eragiketa, round,0))
       Asignacion_Destino[row, col+1] <-  eragiketa
       
       if(col == 1){
        myQuery <- paste0("insert into envio (fecha,sucursal) values('",Sys.Date(),"','",Asignacion_Destino[row,1],"');")
        dbSendQuery(con,myQuery)
       }
      
       if(is.na(maximo$`max(id)`)){
          maximo$`max(id)` <- 0
          myQuery <- paste0("insert into envio_detalles(envio_id,producto_id,cantidad) values('",row,"','",col,"','",eragiketa,"');")
          dbSendQuery(con,myQuery)
          
          myQuery <- paste0("select stock from producto where id = '",col,"';")
          stock <- dbGetQuery(con,myQuery)
          stock <- stock - eragiketa
          myQuery <- paste0("update producto set stock = '",stock,"' where id = '",col,"';")
          dbSendQuery(con,myQuery)
          
        }else{
        
          myQuery <- paste0("insert into envio_detalles(envio_id,producto_id,cantidad) values('",(maximo$`max(id)`+ row),"','",col,"','",eragiketa,"');")
          dbSendQuery(con,myQuery)
          
          myQuery <- paste0("select stock from producto where id = '",col,"';")
          stock <- dbGetQuery(con,myQuery)
          stock <- stock - eragiketa
          myQuery <- paste0("update producto set stock = '",stock,"' where id = '",col,"';")
          dbSendQuery(con,myQuery)
        }
  }
}
  